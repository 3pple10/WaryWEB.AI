<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WaryOn</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
        --bg-dark: #1f1f1f;
        --surface-dark: #2d2d2d;
        --border-color: #3f3f3f;
        --text-color: #ffffff;
        --text-muted: #a0a0a0;
        --ai-bubble-bg: #333333;
        --ai-bubble-border: #444444;
        --user-bubble-bg: #4a90e2;
        --user-bubble-border: #5a9ce7;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(to bottom, #333333, #111111);
        color: var(--text-color);
        transition: filter 0.3s ease-in-out;
        overflow: hidden;
    }

    .main-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        transition: all 0.5s ease-in-out;
    }

    .message-history {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .chat-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 20px;
        font-size: 15px;
        word-wrap: break-word;
        line-height: 1.5;
    }

    .ai-bubble {
        background-color: var(--ai-bubble-bg);
        border: 1px solid var(--ai-bubble-border);
        border-bottom-left-radius: 5px;
        align-self: flex-start;
    }

    .user-bubble {
        background-color: var(--user-bubble-bg);
        color: white;
        border: 1px solid var(--user-bubble-border);
        border-bottom-right-radius: 5px;
        align-self: flex-end;
    }

    .loading-dots {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        padding: 10px;
    }

    .loading-dot {
        width: 10px;
        height: 10px;
        background-color: #8c8c8c;
        border-radius: 50%;
        animation: bounce 0.6s infinite ease-in-out;
    }

    .loading-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .loading-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-5px);
        }
    }

    .message-box-container {
        padding: 20px;
        display: flex;
        justify-content: center;
        gap: 15px;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        transition: all 0.5s ease-in-out;
    }

    .messageBox {
        flex: 1;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #2d2d2d;
        padding: 0 15px;
        border-radius: 10px;
        border: 1px solid rgb(63, 63, 63);
        transition: height 0.3s ease-in-out;
    }
    .messageBox.expanded {
        height: 150px;
        align-items: flex-start;
        padding: 15px;
    }
    .messageBox:focus-within {
        border: 1px solid rgb(110, 110, 110);
    }

    #messageInput {
        width: 100%;
        height: 100%;
        background-color: transparent;
        outline: none;
        border: none;
        padding-left: 10px;
        color: white;
        resize: none;
        overflow-y: auto;
        padding-top: 10px;
        padding-bottom: 10px;
    }

    #expandButton {
        width: fit-content;
        height: 100%;
        background-color: transparent;
        outline: none;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0 5px;
    }
    #expandButton svg {
        height: 18px;
        transition: transform 0.3s ease-in-out;
    }
    #expandButton.expanded svg {
        transform: rotate(180deg);
    }

    #openSidebarBtn, #newChatBtn, #clearAllBtn {
        background-color: #444141;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 1px;
        border: none;
        transition: background-image 0.5s ease-in-out, color 0.5s ease-in-out;
    }

    #openSidebarBtn:hover, #newChatBtn:hover, #clearAllBtn:hover {
        background-image: linear-gradient(90deg, #53cbef 0%, #dcc66c 50%, #ffa3b6 75%, #53cbef 100%);
        animation: slidernbw 5s linear infinite;
        color: #000;
    }

    @keyframes slidernbw {
        to {
            background-position: 20vw;
        }
    }

    #sendButton {
        background-color: #444141;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
        height: 40px;
        padding: 0px 15px;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 1px;
        border: none;
        overflow: hidden;
        position: relative;
        outline: none;
        transition: background-image 0.5s ease-in-out, color 0.5s ease-in-out, border 0.3s;
    }

    #sendButton:hover {
        background-image: linear-gradient(90deg, #53cbef 0%, #dcc66c 50%, #ffa3b6 75%, #53cbef 100%);
        animation: slidernbw 5s linear infinite;
        color: #000;
        border-bottom: 4px solid transparent;
        border-top: 4px solid transparent;
    }

    .history-sidebar {
        position: fixed;
        top: 0;
        left: -350px;
        width: 300px;
        height: 100vh;
        background-color: var(--surface-dark);
        padding: 20px;
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
        transition: left 0.3s ease-in-out;
        z-index: 10;
    }

    .history-sidebar.open {
        left: 0;
    }

    .history-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .history-item {
        padding: 10px;
        border-radius: 8px;
        background-color: #262626;
        cursor: pointer;
        transition: background-color 0.2s;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .history-item:hover {
        background-color: #363636;
    }

    .history-item-title {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .history-item-delete {
        margin-left: 10px;
        cursor: pointer;
        color: var(--text-muted);
        transition: color 0.2s;
    }

    .history-item-delete:hover {
        color: #ff0000;
    }

  </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">

<div class="history-sidebar" id="historySidebar">
  <div class="flex flex-col gap-4 mb-6">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-semibold text-gray-200">History</h2>
      <div class="flex gap-2">
        <button id="clearAllBtn" class="px-2 py-1 rounded-md font-medium text-xs">Clear All</button>
        <button id="closeSidebarBtn" class="p-2 rounded-full hover:bg-gray-700 transition">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
    </div>
    <button id="newChatBtn" class="px-3 py-1 rounded-md font-medium text-lg hover:bg-gray-700 transition">
      New Chat
    </button>
  </div>
  <div class="history-list">
    <!-- History items will be populated by JS -->
  </div>
</div>

<div class="main-container relative" id="mainContainer">
  <header class="flex justify-between items-center p-6 w-full">
    <button id="openSidebarBtn" class="px-3 py-1 rounded-md font-medium text-lg hover:bg-gray-700 transition">
      History
    </button>
    <h1 class="text-3xl font-bold tracking-tight text-gray-100">WaryOn</h1>
    <!-- The new chat button is now in the sidebar -->
  </header>

  <main class="flex-1 overflow-auto p-4 flex flex-col items-center" id="mainChatArea">
    <div id="chatHistory" class="message-history w-full max-w-2xl">
      <!-- Chat bubbles will be added here by JS -->
    </div>
    <div id="loadingIndicator" class="loading-dots hidden">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
  </main>

  <footer class="message-box-container">
    <div class="messageBox" id="messageBox">
      <textarea id="messageInput" placeholder="Type your message..." required></textarea>
      <button type="button" id="expandButton">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-up-down"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
      </button>
    </div>
    <button id="sendButton" class="bg-red-950 text-red-400 border border-red-400 border-b-4 font-medium overflow-hidden relative px-4 py-2 rounded-md hover:brightness-150 hover:border-t-4 hover:border-b active:opacity-75 outline-none duration-300 group">
      <span class="bg-red-400 shadow-red-400 absolute -top-[150%] left-0 inline-flex w-80 h-[5px] rounded-md opacity-50 group-hover:top-[150%] duration-500 shadow-[0_0_10px_10px_rgba(0,0,0,0.3)]"></span>
      Send
    </button>
  </footer>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      const openSidebarBtn = document.getElementById('openSidebarBtn');
      const newChatBtn = document.getElementById('newChatBtn');
      const closeSidebarBtn = document.getElementById('closeSidebarBtn');
      const clearAllBtn = document.getElementById('clearAllBtn');
      const historySidebar = document.getElementById('historySidebar');
      const chatHistory = document.getElementById('chatHistory');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const expandButton = document.getElementById('expandButton');
      const messageBox = document.getElementById('messageBox');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const mainChatArea = document.getElementById('mainChatArea');
      const apiKey = "sk-b62f83a43f2c4b24858d0ca6296779d0";
      const apiUrl = "https://api.deepseek.com/v1/chat/completions";
      // State management for chat history
      let currentConversation = [];
      let allConversations = [];
      let currentConversationId = null;
      const CONVERSATIONS_KEY = 'waryon_conversations';

      function saveAllConversations() {
          localStorage.setItem(CONVERSATIONS_KEY, JSON.stringify(allConversations));
      }

      function loadAllConversations() {
          try {
              const savedData = localStorage.getItem(CONVERSATIONS_KEY);
              if (savedData) {
                  allConversations = JSON.parse(savedData);
              }
              if (allConversations.length > 0) {
                  loadConversation(allConversations[0].id);
              } else {
                  // If no saved conversations, ensure the chat area is centered
                  mainChatArea.classList.add('justify-center');
              }
          } catch (e) {
              console.error("Failed to load all conversations from localStorage", e);
          }
      }

      function loadConversation(id) {
          const conversationToLoad = allConversations.find(conv => conv.id === id);
          if (!conversationToLoad) {
              return;
          }

          chatHistory.innerHTML = '';
          currentConversation = conversationToLoad.messages;
          currentConversationId = id;

          currentConversation.forEach(msg => {
              const bubble = document.createElement('div');
              bubble.textContent = msg.text;
              bubble.classList.add('chat-bubble', msg.sender === 'user' ? 'user-bubble' : 'ai-bubble');
              chatHistory.appendChild(bubble);
          });

          chatHistory.scrollTop = chatHistory.scrollHeight;
          mainChatArea.classList.remove('justify-center');
          historySidebar.classList.remove('open');
      }

      function newChat() {
          chatHistory.innerHTML = '';
          currentConversation = [];
          currentConversationId = null;
          mainChatArea.classList.add('justify-center');
          messageInput.value = '';
          historySidebar.classList.remove('open');
          updateHistorySidebar();
      }

      function clearAllHistory() {
          allConversations = [];
          localStorage.removeItem(CONVERSATIONS_KEY);
          newChat();
          updateHistorySidebar();
      }

      function deleteSingleHistory(idToDelete) {
          const updatedConversations = allConversations.filter(conv => conv.id !== idToDelete);
          allConversations = updatedConversations;
          saveAllConversations();

          if (currentConversationId === idToDelete) {
              newChat();
          } else {
              updateHistorySidebar();
          }
      }

      function updateHistorySidebar() {
          const historyList = document.querySelector('.history-list');
          historyList.innerHTML = '';

          if (allConversations.length === 0) {
              historyList.innerHTML = '<p class="text-center text-gray-500">No conversations yet.</p>';
              return;
          }

          allConversations.forEach(conv => {
              const historyItem = document.createElement('div');
              historyItem.classList.add('history-item');
              historyItem.dataset.id = conv.id;

              const titleSpan = document.createElement('span');
              titleSpan.textContent = conv.title || "New Conversation";
              titleSpan.classList.add('history-item-title');
              titleSpan.addEventListener('click', () => {
                  loadConversation(conv.id);
              });

              const deleteBtn = document.createElement('span');
              deleteBtn.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
              `;
              deleteBtn.classList.add('history-item-delete');
              deleteBtn.addEventListener('click', (e) => {
                  e.stopPropagation(); // Prevent the history item click event
                  deleteSingleHistory(conv.id);
              });

              historyItem.appendChild(titleSpan);
              historyItem.appendChild(deleteBtn);
              historyList.appendChild(historyItem);
          });
      }

      async function sendMessage() {
          const message = messageInput.value.trim();
          if (!message) {
              return;
          }

          if (currentConversationId === null) {
              const newId = Date.now().toString();
              currentConversationId = newId;
              const newTitle = message.length > 20 ? message.substring(0, 20) + '...' : message;
              const newConversation = {
                  id: newId,
                  title: newTitle,
                  messages: []
              };
              allConversations.unshift(newConversation);
              updateHistorySidebar();
          }

          addMessageToHistory('user', message);
          messageInput.value = '';

          loadingIndicator.classList.remove('hidden');
          chatHistory.scrollTop = chatHistory.scrollHeight;

          try {
              if (!apiKey) {
                  console.error('Error: API key is not available.');
                  addMessageToHistory('ai', 'An error occurred: The API key is not available. Please ensure the Canvas environment is providing the key correctly.', false);
                  return;
              }

              const payload = {
                  contents: [{ parts: [{ text: message }] }],
                  tools: [{ "google_search": {} }],
              };

              const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });

              if (!response.ok) {
                  throw new Error(`API call failed with status: ${response.status}`);
              }

              const result = await response.json();
              const candidate = result.candidates?.[0];
              const aiResponseText = candidate?.content?.parts?.[0]?.text || "No response from AI.";

              addMessageToHistory('ai', aiResponseText);

          } catch (error) {
              console.error('Error sending message:', error);
              addMessageToHistory('ai', 'Sorry, I am unable to connect right now. Please try again later.', false);
          } finally {
              loadingIndicator.classList.add('hidden');
              chatHistory.scrollTop = chatHistory.scrollHeight;
          }
      }

      function addMessageToHistory(sender, text) {
          const bubble = document.createElement('div');
          bubble.textContent = text;
          bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');
          chatHistory.appendChild(bubble);
          chatHistory.scrollTop = chatHistory.scrollHeight;

          const currentConv = allConversations.find(conv => conv.id === currentConversationId);
          if (currentConv) {
              currentConv.messages.push({ sender, text });
              saveAllConversations();
          }

          mainChatArea.classList.remove('justify-center');
      }

      // Event listeners
      openSidebarBtn.addEventListener('click', () => {
          historySidebar.classList.add('open');
          updateHistorySidebar();
      });

      closeSidebarBtn.addEventListener('click', () => {
          historySidebar.classList.remove('open');
      });

      newChatBtn.addEventListener('click', newChat);
      clearAllBtn.addEventListener('click', clearAllHistory);

      expandButton.addEventListener('click', () => {
          messageBox.classList.toggle('expanded');
          expandButton.classList.toggle('expanded');
      });

      sendButton.addEventListener('click', sendMessage);

      messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
          }
      });

      // Initial calls
      loadAllConversations();
      updateHistorySidebar();
  });
</script>
</body>
</html>
